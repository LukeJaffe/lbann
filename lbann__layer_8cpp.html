<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>LBANN: src/layers/lbann_layer.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="contents">
<h1>src/layers/lbann_layer.cpp File Reference</h1><code>#include &quot;<a class="el" href="lbann__layer_8hpp_source.html">lbann/layers/lbann_layer.hpp</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lbann__regularizer_8hpp_source.html">lbann/regularization/lbann_regularizer.hpp</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lbann__timer_8hpp_source.html">lbann/utils/lbann_timer.hpp</a>&quot;</code><br/>
<code>#include &lt;string&gt;</code><br/>
<code>#include &lt;sys/types.h&gt;</code><br/>
<code>#include &lt;sys/stat.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<div class="dynheader">
Include dependency graph for lbann_layer.cpp:</div>
<div class="dynsection">
<div class="center"><img src="lbann__layer_8cpp__incl.png" border="0" usemap="#src_2layers_2lbann__layer_8cpp_map" alt=""/></div>
<map name="src_2layers_2lbann__layer_8cpp_map" id="src_2layers_2lbann__layer_8cpp">
<area shape="rect" id="node3" href="lbann__layer_8hpp.html" title="lbann/layers/lbann_layer.hpp" alt="" coords="983,160,1170,189"/><area shape="rect" id="node49" href="lbann__regularizer_8hpp.html" title="lbann/regularization/lbann_regularizer.hpp" alt="" coords="946,83,1207,112"/><area shape="rect" id="node53" href="lbann__timer_8hpp.html" title="lbann/utils/lbann_timer.hpp" alt="" coords="1367,83,1543,112"/><area shape="rect" id="node5" href="lbann__base_8hpp.html" title="lbann/lbann_base.hpp" alt="" coords="379,469,526,499"/><area shape="rect" id="node13" href="lbann__comm_8hpp.html" title="lbann/lbann_comm.hpp" alt="" coords="847,392,1002,421"/><area shape="rect" id="node18" href="lbann__layer__activations_8hpp.html" title="lbann/layers/lbann_layer_activations.hpp" alt="" coords="44,392,300,421"/><area shape="rect" id="node21" href="lbann__summary_8hpp.html" title="lbann/utils/lbann_summary.hpp" alt="" coords="988,315,1191,344"/><area shape="rect" id="node28" href="lbann__optimizer_8hpp.html" title="lbann/optimizers/lbann_optimizer.hpp" alt="" coords="676,315,914,344"/><area shape="rect" id="node34" href="lbann__optimizer__sgd_8hpp.html" title="lbann/optimizers/lbann_optimizer_sgd.hpp" alt="" coords="146,237,410,267"/><area shape="rect" id="node39" href="lbann__optimizer__adagrad_8hpp.html" title="lbann/optimizers/lbann_optimizer_adagrad.hpp" alt="" coords="434,237,724,267"/><area shape="rect" id="node43" href="lbann__optimizer__rmsprop_8hpp.html" title="lbann/optimizers/lbann_optimizer_rmsprop.hpp" alt="" coords="748,237,1039,267"/><area shape="rect" id="node7" href="datatype_8hpp.html" title="datatype.hpp" alt="" coords="354,547,450,576"/></map>
</div>

<p><a href="lbann__layer_8cpp_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlayer__header.html">layer_header</a></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lbann__layer_8cpp.html#aec1a3889694dc0ee7c604743f5e7dbf5">writeDist</a> (int fd, const char *filename, const <a class="el" href="lbann__base_8hpp.html#a270ddda44ad6a3abd3cfe8358cf581e6">DistMat</a> &amp;M, uint64_t *bytes)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lbann__layer_8cpp.html#a0fdf1d9b9887a4bb469ae5dd9d5cede9">readDist</a> (int fd, const char *filename, <a class="el" href="lbann__base_8hpp.html#a270ddda44ad6a3abd3cfe8358cf581e6">DistMat</a> &amp;M, uint64_t *bytes)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lbann__layer_8cpp.html#aecb37a9bbeb1d09e7efd47d23a3a9d9a">create_types</a> (const DistMatrix&lt; <a class="el" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a> &gt; &amp;M, MPI_Datatype *mattype, MPI_Datatype *viewtype)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lbann__layer_8cpp.html#ab4c41c2a753542357d6b12fb6876db19">Write_MPI</a> (const DistMatrix&lt; <a class="el" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a> &gt; &amp;M, std::string basename=&quot;DistMatrix&quot;, FileFormat format=BINARY, std::string title=&quot;&quot;)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lbann__layer_8cpp.html#a7495d1b9fc4b8193811308471c4066a0">Read_MPI</a> (DistMatrix&lt; <a class="el" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a> &gt; &amp;M, std::string filename, FileFormat format=BINARY, bool sequential=false)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="aecb37a9bbeb1d09e7efd47d23a3a9d9a"></a><!-- doxytag: member="lbann_layer.cpp::create_types" ref="aecb37a9bbeb1d09e7efd47d23a3a9d9a" args="(const DistMatrix&lt; DataType &gt; &amp;M, MPI_Datatype *mattype, MPI_Datatype *viewtype)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void create_types </td>
          <td>(</td>
          <td class="paramtype">const DistMatrix&lt; <a class="el" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a> &gt; &amp;&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MPI_Datatype *&nbsp;</td>
          <td class="paramname"> <em>mattype</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">MPI_Datatype *&nbsp;</td>
          <td class="paramname"> <em>viewtype</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lbann__layer_8cpp_source.html#l00274">274</a> of file <a class="el" href="lbann__layer_8cpp_source.html">lbann_layer.cpp</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <span class="comment">// initialize to known values</span>
<a name="l00277"></a>00277     *mattype  = MPI_DATATYPE_NULL;
<a name="l00278"></a>00278     *viewtype = MPI_DATATYPE_NULL;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="comment">// TODO: use TypeMap&lt;&gt;() and templating to figure this out</span>
<a name="l00281"></a>00281     MPI_Datatype type = <a class="code" href="lbann__base_8hpp.html#a50107efba2c08b6188a769743a78d04e">DataTypeMPI</a>;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="comment">// get global width and height of matrix</span>
<a name="l00284"></a>00284     Int global_width  = M.Width();
<a name="l00285"></a>00285     Int global_height = M.Height();
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     <span class="comment">// get local width and height, plus leading dimension of local matrix</span>
<a name="l00288"></a>00288     Int W    = M.LocalWidth();
<a name="l00289"></a>00289     Int H    = M.LocalHeight();
<a name="l00290"></a>00290     Int LDim = M.LDim();
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="comment">// create a datatype to describe libelemental data in memory,</span>
<a name="l00293"></a>00293     <span class="comment">// data is stored in column-major order with a local height of H</span>
<a name="l00294"></a>00294     <span class="comment">// and a local width of W, also the leading dimension LDim &gt;= H</span>
<a name="l00295"></a>00295     <span class="comment">// so there may be holes in our local buffer between consecutive</span>
<a name="l00296"></a>00296     <span class="comment">// columns which we need to account for</span>
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="comment">// first we have H consecutive elements in a column</span>
<a name="l00299"></a>00299     MPI_Datatype tmptype;
<a name="l00300"></a>00300     MPI_Type_contiguous(H, type, &amp;tmptype);
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     <span class="comment">// then there may be some holes at then end of our column,</span>
<a name="l00303"></a>00303     <span class="comment">// since LDim &gt;= H</span>
<a name="l00304"></a>00304     MPI_Datatype coltype;
<a name="l00305"></a>00305     MPI_Aint extent = LDim * <span class="keyword">sizeof</span>(<a class="code" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a>);
<a name="l00306"></a>00306     MPI_Type_create_resized(tmptype, 0, extent, &amp;coltype);
<a name="l00307"></a>00307     MPI_Type_free(&amp;tmptype);
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="comment">// finally we have W such columns</span>
<a name="l00310"></a>00310     MPI_Type_contiguous(W, coltype, mattype);
<a name="l00311"></a>00311     MPI_Type_free(&amp;coltype);
<a name="l00312"></a>00312     MPI_Type_commit(mattype);
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     <span class="comment">// create datatype to desribe fileview for a collective IO operation</span>
<a name="l00315"></a>00315     <span class="comment">// we will store matrix in column-major order in the file</span>
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     <span class="comment">// get width and height of the process grid</span>
<a name="l00318"></a>00318     <span class="keywordtype">int</span> rank    = M.Grid().Rank();
<a name="l00319"></a>00319     <span class="keywordtype">int</span> ranks   = M.Grid().Size();
<a name="l00320"></a>00320     <span class="keywordtype">int</span> pheight = M.Grid().Height();
<a name="l00321"></a>00321     <span class="keywordtype">int</span> pwidth  = M.Grid().Width();
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     <span class="comment">// TODO: need to account for alignment if user has set this</span>
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     <span class="comment">// create_darray expects processes to be in row-major order,</span>
<a name="l00326"></a>00326     <span class="comment">// find our global rank in row-major order</span>
<a name="l00327"></a>00327     <span class="keywordtype">int</span> prow = M.Grid().Row();
<a name="l00328"></a>00328     <span class="keywordtype">int</span> pcol = M.Grid().Col();
<a name="l00329"></a>00329     <span class="keywordtype">int</span> row_major_rank = prow * pwidth + pcol;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="keywordtype">int</span> gsizes[2];
<a name="l00332"></a>00332     gsizes[0] = global_height;
<a name="l00333"></a>00333     gsizes[1] = global_width;
<a name="l00334"></a>00334     <span class="keywordtype">int</span> distribs[2] = {MPI_DISTRIBUTE_CYCLIC, MPI_DISTRIBUTE_CYCLIC};
<a name="l00335"></a>00335     <span class="comment">// TODO: if using block sizes &gt; 1, then change dargs below (BlockHeight, BlockWidth)</span>
<a name="l00336"></a>00336     <span class="keywordtype">int</span> dargs[2] = {1, 1};
<a name="l00337"></a>00337     <span class="keywordtype">int</span> psizes[2];
<a name="l00338"></a>00338     psizes[0] = pheight;
<a name="l00339"></a>00339     psizes[1] = pwidth;
<a name="l00340"></a>00340     MPI_Type_create_darray(ranks, row_major_rank, 2, gsizes, distribs, dargs, psizes, MPI_ORDER_FORTRAN, type, viewtype);
<a name="l00341"></a>00341     MPI_Type_commit(viewtype);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="keywordflow">return</span>;
<a name="l00344"></a>00344 }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="lbann__layer_8cpp_aecb37a9bbeb1d09e7efd47d23a3a9d9a_icgraph.png" border="0" usemap="#lbann__layer_8cpp_aecb37a9bbeb1d09e7efd47d23a3a9d9a_icgraph_map" alt=""></div>
<map name="lbann__layer_8cpp_aecb37a9bbeb1d09e7efd47d23a3a9d9a_icgraph_map" id="lbann__layer_8cpp_aecb37a9bbeb1d09e7efd47d23a3a9d9a_icgraph">
<area shape="rect" id="node3" href="lbann__layer_8cpp.html#a7495d1b9fc4b8193811308471c4066a0" title="Read_MPI" alt="" coords="153,5,236,35"/><area shape="rect" id="node5" href="lbann__layer_8cpp.html#ab4c41c2a753542357d6b12fb6876db19" title="Write_MPI" alt="" coords="153,59,236,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a7495d1b9fc4b8193811308471c4066a0"></a><!-- doxytag: member="lbann_layer.cpp::Read_MPI" ref="a7495d1b9fc4b8193811308471c4066a0" args="(DistMatrix&lt; DataType &gt; &amp;M, std::string filename, FileFormat format=BINARY, bool sequential=false)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Read_MPI </td>
          <td>(</td>
          <td class="paramtype">DistMatrix&lt; <a class="el" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a> &gt; &amp;&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::string&nbsp;</td>
          <td class="paramname"> <em>filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FileFormat&nbsp;</td>
          <td class="paramname"> <em>format</em> = <code>BINARY</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>sequential</em> = <code>false</code></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lbann__layer_8cpp_source.html#l00431">431</a> of file <a class="el" href="lbann__layer_8cpp_source.html">lbann_layer.cpp</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00432"></a>00432 {
<a name="l00433"></a>00433     <span class="comment">// TODO: error out if format != BINARY</span>
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="comment">// TODO: use TypeMap&lt;&gt;() and templating to figure this out</span>
<a name="l00436"></a>00436     MPI_Datatype type = <a class="code" href="lbann__base_8hpp.html#a50107efba2c08b6188a769743a78d04e">DataTypeMPI</a>;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <span class="comment">// define our file name</span>
<a name="l00439"></a>00439     <span class="keyword">const</span> <span class="keywordtype">char</span>* path = filename.c_str();
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="comment">// get MPI communicator</span>
<a name="l00442"></a>00442     MPI_Comm <a class="code" href="lbann__file__io_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a> = M.Grid().Comm().comm;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="comment">// get our rank</span>
<a name="l00445"></a>00445     <span class="keywordtype">int</span> rank = M.Grid().Rank();
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="comment">// open the file</span>
<a name="l00448"></a>00448     MPI_File fh;
<a name="l00449"></a>00449     MPI_Status status;
<a name="l00450"></a>00450     <span class="keywordtype">char</span> datarep[] = <span class="stringliteral">&quot;native&quot;</span>;
<a name="l00451"></a>00451     <span class="keywordtype">int</span> amode = MPI_MODE_RDONLY;
<a name="l00452"></a>00452     <span class="keywordtype">int</span> rc = MPI_File_open(comm, path, amode, MPI_INFO_NULL, &amp;fh);
<a name="l00453"></a>00453     <span class="keywordflow">if</span> (rc != MPI_SUCCESS) {
<a name="l00454"></a>00454         <span class="keywordflow">if</span> (rank == 0) {
<a name="l00455"></a>00455             cout &lt;&lt; <span class="stringliteral">&quot;Failed to open file `&quot;</span> &lt;&lt; path &lt;&lt; <span class="stringliteral">&quot;&apos;&quot;</span> &lt;&lt; endl;
<a name="l00456"></a>00456         }
<a name="l00457"></a>00457         <span class="keywordflow">return</span>;
<a name="l00458"></a>00458     }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <span class="comment">// set displacement to beginning of file</span>
<a name="l00461"></a>00461     MPI_Offset disp = 0;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <span class="comment">// set our view to read header (height and width as unsigned 32-bit ints)</span>
<a name="l00464"></a>00464     uint32_t dimensions[2];
<a name="l00465"></a>00465     MPI_File_set_view(fh, disp, MPI_UINT32_T, MPI_UINT32_T, datarep, MPI_INFO_NULL);
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (rank == 0) {
<a name="l00467"></a>00467         MPI_File_read_at(fh, 0, dimensions, 2, MPI_UINT32_T, &amp;status);
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469     disp += 2 * <span class="keyword">sizeof</span>(uint32_t);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="comment">// broadcast dimensions from rank 0</span>
<a name="l00472"></a>00472     MPI_Bcast(dimensions, 2, MPI_UINT32_T, 0, comm);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="comment">// resize matrix to hold data</span>
<a name="l00475"></a>00475     Int global_height = dimensions[0];
<a name="l00476"></a>00476     Int global_width  = dimensions[1];
<a name="l00477"></a>00477     M.Resize(global_height, global_width);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <span class="comment">// now define datatypes to describe local buffer and view into file</span>
<a name="l00480"></a>00480     MPI_Datatype mattype, viewtype;
<a name="l00481"></a>00481     <a class="code" href="lbann__layer_8cpp.html#aecb37a9bbeb1d09e7efd47d23a3a9d9a">create_types</a>(M, &amp;mattype, &amp;viewtype);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="comment">// set view to write data</span>
<a name="l00484"></a>00484     MPI_File_set_view(fh, disp, type, viewtype, datarep, MPI_INFO_NULL);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     <span class="comment">// write our portion of the matrix, since we set our view using create_darray,</span>
<a name="l00487"></a>00487     <span class="comment">// all procs write at offset 0, the file view will take care of interleaving appropriately</span>
<a name="l00488"></a>00488     <span class="keywordtype">char</span>* buf = (<span class="keywordtype">char</span>*) M.Buffer();
<a name="l00489"></a>00489     MPI_File_read_at_all(fh, 0, buf, 1, mattype, &amp;status);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <span class="comment">// close file</span>
<a name="l00492"></a>00492     MPI_File_close(&amp;fh);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="comment">// free our datatypes</span>
<a name="l00495"></a>00495     MPI_Type_free(&amp;mattype);
<a name="l00496"></a>00496     MPI_Type_free(&amp;viewtype);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="keywordflow">return</span>;
<a name="l00499"></a>00499 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="lbann__layer_8cpp_a7495d1b9fc4b8193811308471c4066a0_cgraph.png" border="0" usemap="#lbann__layer_8cpp_a7495d1b9fc4b8193811308471c4066a0_cgraph_map" alt=""></div>
<map name="lbann__layer_8cpp_a7495d1b9fc4b8193811308471c4066a0_cgraph_map" id="lbann__layer_8cpp_a7495d1b9fc4b8193811308471c4066a0_cgraph">
<area shape="rect" id="node3" href="lbann__layer_8cpp.html#aecb37a9bbeb1d09e7efd47d23a3a9d9a" title="create_types" alt="" coords="140,5,236,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0fdf1d9b9887a4bb469ae5dd9d5cede9"></a><!-- doxytag: member="lbann_layer.cpp::readDist" ref="a0fdf1d9b9887a4bb469ae5dd9d5cede9" args="(int fd, const char *filename, DistMat &amp;M, uint64_t *bytes)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool readDist </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="lbann__base_8hpp.html#a270ddda44ad6a3abd3cfe8358cf581e6">DistMat</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t *&nbsp;</td>
          <td class="paramname"> <em>bytes</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lbann__layer_8cpp_source.html#l00211">211</a> of file <a class="el" href="lbann__layer_8cpp_source.html">lbann_layer.cpp</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00212"></a>00212 {
<a name="l00213"></a>00213     <span class="keyword">struct </span><a class="code" href="structlayer__header.html">layer_header</a> header;
<a name="l00214"></a>00214     ssize_t read_rc = read(fd, &amp;header, <span class="keyword">sizeof</span>(header));
<a name="l00215"></a>00215     <span class="keywordflow">if</span> (read_rc != <span class="keyword">sizeof</span>(header)) {
<a name="l00216"></a>00216         <span class="comment">// error!</span>
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218     *bytes += read_rc;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="comment">// check that header values match up</span>
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     Int <a class="code" href="structlayer__header.html#ad986e4b92e5b455e066fd349725c6bd9">height</a> = header.height;
<a name="l00223"></a>00223     Int <a class="code" href="structlayer__header.html#af1f45c9c74db048ea424114418f22d50">width</a>  = header.width;
<a name="l00224"></a>00224     M.Resize(height, width);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="keywordflow">if</span>(M.ColStride() == 1 &amp;&amp; M.RowStride() == 1) {
<a name="l00227"></a>00227         <span class="keywordflow">if</span>(M.Height() == M.LDim()) {
<a name="l00228"></a>00228             <span class="keywordtype">void</span>* buf = (<span class="keywordtype">void</span>*) M.Buffer();
<a name="l00229"></a>00229             <span class="keywordtype">size_t</span> bufsize = height * width * <span class="keyword">sizeof</span>(<a class="code" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a>);
<a name="l00230"></a>00230             read_rc = read(fd, buf, bufsize);
<a name="l00231"></a>00231             <span class="keywordflow">if</span> (read_rc != bufsize) {
<a name="l00232"></a>00232                 <span class="comment">// error!</span>
<a name="l00233"></a>00233             }
<a name="l00234"></a>00234             *bytes += read_rc;
<a name="l00235"></a>00235         } <span class="keywordflow">else</span> {
<a name="l00236"></a>00236             <span class="keywordflow">for</span>(Int j = 0; j &lt; width; ++j) {
<a name="l00237"></a>00237                 <span class="keywordtype">void</span>* buf = (<span class="keywordtype">void</span>*) M.Buffer(0, j);
<a name="l00238"></a>00238                 <span class="keywordtype">size_t</span> bufsize = height * <span class="keyword">sizeof</span>(<a class="code" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a>);
<a name="l00239"></a>00239                 read_rc = read(fd, buf, bufsize);
<a name="l00240"></a>00240                 <span class="keywordflow">if</span> (read_rc != bufsize) {
<a name="l00241"></a>00241                     <span class="comment">// error!</span>
<a name="l00242"></a>00242                 }
<a name="l00243"></a>00243                 *bytes += read_rc;
<a name="l00244"></a>00244             }
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246     } <span class="keywordflow">else</span> {
<a name="l00247"></a>00247         <span class="keyword">const</span> Int localHeight = M.LocalHeight();
<a name="l00248"></a>00248         <span class="keyword">const</span> Int localWidth = M.LocalWidth();
<a name="l00249"></a>00249         <span class="keyword">const</span> Int lDim = M.LDim();
<a name="l00250"></a>00250         <span class="keywordflow">if</span>(localHeight == lDim) {
<a name="l00251"></a>00251             <span class="keywordtype">void</span>* buf = (<span class="keywordtype">void</span>*) M.Buffer();
<a name="l00252"></a>00252             <span class="keywordtype">size_t</span> bufsize = localHeight * localWidth * <span class="keyword">sizeof</span>(<a class="code" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a>);
<a name="l00253"></a>00253             read_rc = read(fd, buf, bufsize);
<a name="l00254"></a>00254             <span class="keywordflow">if</span> (read_rc != bufsize) {
<a name="l00255"></a>00255                 <span class="comment">// error!</span>
<a name="l00256"></a>00256             }
<a name="l00257"></a>00257             *bytes += read_rc;
<a name="l00258"></a>00258         } <span class="keywordflow">else</span> {
<a name="l00259"></a>00259             <span class="keywordflow">for</span>(Int jLoc = 0; jLoc &lt; localWidth; ++jLoc) {
<a name="l00260"></a>00260                 <span class="keywordtype">void</span>* buf = (<span class="keywordtype">void</span>*) M.Buffer(0, jLoc);
<a name="l00261"></a>00261                 <span class="keywordtype">size_t</span> bufsize = localHeight * <span class="keyword">sizeof</span>(<a class="code" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a>);
<a name="l00262"></a>00262                 read_rc = read(fd, buf, bufsize);
<a name="l00263"></a>00263                 <span class="keywordflow">if</span> (read_rc != bufsize) {
<a name="l00264"></a>00264                     <span class="comment">// error!</span>
<a name="l00265"></a>00265                 }
<a name="l00266"></a>00266                 *bytes += read_rc;
<a name="l00267"></a>00267             }
<a name="l00268"></a>00268         }
<a name="l00269"></a>00269     }
<a name="l00270"></a>00270     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00271"></a>00271 }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="lbann__layer_8cpp_a0fdf1d9b9887a4bb469ae5dd9d5cede9_icgraph.png" border="0" usemap="#lbann__layer_8cpp_a0fdf1d9b9887a4bb469ae5dd9d5cede9_icgraph_map" alt=""></div>
<map name="lbann__layer_8cpp_a0fdf1d9b9887a4bb469ae5dd9d5cede9_icgraph_map" id="lbann__layer_8cpp_a0fdf1d9b9887a4bb469ae5dd9d5cede9_icgraph">
<area shape="rect" id="node3" href="classlbann_1_1Layer.html#a88c3ac4ca87586ec20558aaddda76691" title="lbann::Layer::loadFromCheckpoint" alt="" coords="125,5,347,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab4c41c2a753542357d6b12fb6876db19"></a><!-- doxytag: member="lbann_layer.cpp::Write_MPI" ref="ab4c41c2a753542357d6b12fb6876db19" args="(const DistMatrix&lt; DataType &gt; &amp;M, std::string basename=&quot;DistMatrix&quot;, FileFormat format=BINARY, std::string title=&quot;&quot;)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Write_MPI </td>
          <td>(</td>
          <td class="paramtype">const DistMatrix&lt; <a class="el" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a> &gt; &amp;&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::string&nbsp;</td>
          <td class="paramname"> <em>basename</em> = <code>&quot;DistMatrix&quot;</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FileFormat&nbsp;</td>
          <td class="paramname"> <em>format</em> = <code>BINARY</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::string&nbsp;</td>
          <td class="paramname"> <em>title</em> = <code>&quot;&quot;</code></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lbann__layer_8cpp_source.html#l00346">346</a> of file <a class="el" href="lbann__layer_8cpp_source.html">lbann_layer.cpp</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00347"></a>00347 {
<a name="l00348"></a>00348     <span class="comment">// TODO: error out if format != BINARY</span>
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     <span class="comment">// TODO: use TypeMap&lt;&gt;() and templating to figure this out</span>
<a name="l00351"></a>00351     MPI_Datatype type = <a class="code" href="lbann__base_8hpp.html#a50107efba2c08b6188a769743a78d04e">DataTypeMPI</a>;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     <span class="comment">// define our file name</span>
<a name="l00354"></a>00354     <span class="keywordtype">string</span> filename = basename + <span class="stringliteral">&quot;.&quot;</span> + FileExtension(BINARY);
<a name="l00355"></a>00355     <span class="keyword">const</span> <span class="keywordtype">char</span>* path = filename.c_str();
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="comment">// get MPI communicator</span>
<a name="l00358"></a>00358     MPI_Comm <a class="code" href="lbann__file__io_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a> = M.Grid().Comm().comm;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="comment">// get our rank</span>
<a name="l00361"></a>00361     <span class="keywordtype">int</span> <a class="code" href="structlayer__header.html#a325142c0466170c6627710106275c7fd">rank</a> = M.Grid().Rank();
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="comment">// first, delete the existing file</span>
<a name="l00364"></a>00364     <span class="keywordflow">if</span> (rank == 0) {
<a name="l00365"></a>00365         <span class="comment">/*</span>
<a name="l00366"></a>00366 <span class="comment">        int unlink_rc = unlink(path);</span>
<a name="l00367"></a>00367 <span class="comment">        if (unlink_rc != 0) {</span>
<a name="l00368"></a>00368 <span class="comment">            fprintf(stderr, &quot;Error deleting file `%s&apos;\n&quot;, path);</span>
<a name="l00369"></a>00369 <span class="comment">            fflush(stderr);</span>
<a name="l00370"></a>00370 <span class="comment">        }</span>
<a name="l00371"></a>00371 <span class="comment">        */</span>
<a name="l00372"></a>00372         MPI_File_delete(path, MPI_INFO_NULL);
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <span class="comment">// get global width and height of matrix</span>
<a name="l00376"></a>00376     Int global_width  = M.Width();
<a name="l00377"></a>00377     Int global_height = M.Height();
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <span class="comment">// define datatypes to describe local buffer and view into file</span>
<a name="l00380"></a>00380     MPI_Datatype mattype, viewtype;
<a name="l00381"></a>00381     <a class="code" href="lbann__layer_8cpp.html#aecb37a9bbeb1d09e7efd47d23a3a9d9a">create_types</a>(M, &amp;mattype, &amp;viewtype);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="comment">// define hints for creating the file (e.g., number of stripes on Lustre)</span>
<a name="l00384"></a>00384     MPI_Info info;
<a name="l00385"></a>00385     MPI_Info_create(&amp;info);
<a name="l00386"></a>00386     MPI_Info_set(info, <span class="stringliteral">&quot;striping_factor&quot;</span>, <span class="stringliteral">&quot;10&quot;</span>);
<a name="l00387"></a>00387     <span class="comment">//MPI_Info_set(info, &quot;striping_factor&quot;, &quot;80&quot;);</span>
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="comment">// open the file</span>
<a name="l00390"></a>00390     MPI_File fh;
<a name="l00391"></a>00391     MPI_Status status;
<a name="l00392"></a>00392     <span class="keywordtype">char</span> datarep[] = <span class="stringliteral">&quot;native&quot;</span>;
<a name="l00393"></a>00393     <span class="keywordtype">int</span> amode = MPI_MODE_WRONLY | MPI_MODE_CREATE;
<a name="l00394"></a>00394     MPI_File_open(comm, path, amode, info, &amp;fh);
<a name="l00395"></a>00395 
<a name="l00396"></a>00396     <span class="comment">// done with the info object</span>
<a name="l00397"></a>00397     MPI_Info_free(&amp;info);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="comment">// truncate file to 0 bytes</span>
<a name="l00400"></a>00400 <span class="comment">//    MPI_File_set_size(fh, 0);</span>
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <span class="comment">// set our view to write header (height and width as unsigned 32-bit ints)</span>
<a name="l00403"></a>00403     MPI_Offset disp = 0;
<a name="l00404"></a>00404     MPI_File_set_view(fh, disp, MPI_UINT32_T, MPI_UINT32_T, datarep, MPI_INFO_NULL);
<a name="l00405"></a>00405     <span class="keywordflow">if</span> (rank == 0) {
<a name="l00406"></a>00406         uint32_t dimensions[2];
<a name="l00407"></a>00407         dimensions[0] = global_height;
<a name="l00408"></a>00408         dimensions[1] = global_width;
<a name="l00409"></a>00409         MPI_File_write_at(fh, 0, dimensions, 2, MPI_UINT32_T, &amp;status);
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411     disp += 2 * <span class="keyword">sizeof</span>(uint32_t);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="comment">// set view to write data</span>
<a name="l00414"></a>00414     MPI_File_set_view(fh, disp, type, viewtype, datarep, MPI_INFO_NULL);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <span class="comment">// write our portion of the matrix, since we set our view using create_darray,</span>
<a name="l00417"></a>00417     <span class="comment">// all procs write at offset 0, the file view will take care of interleaving appropriately</span>
<a name="l00418"></a>00418     <span class="keyword">const</span> <span class="keywordtype">char</span>* buf = (<span class="keyword">const</span> <span class="keywordtype">char</span>*) M.LockedBuffer();
<a name="l00419"></a>00419     MPI_File_write_at_all(fh, 0, buf, 1, mattype, &amp;status);
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     <span class="comment">// close file</span>
<a name="l00422"></a>00422     MPI_File_close(&amp;fh);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="comment">// free our datatypes</span>
<a name="l00425"></a>00425     MPI_Type_free(&amp;mattype);
<a name="l00426"></a>00426     MPI_Type_free(&amp;viewtype);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="keywordflow">return</span>;
<a name="l00429"></a>00429 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="lbann__layer_8cpp_ab4c41c2a753542357d6b12fb6876db19_cgraph.png" border="0" usemap="#lbann__layer_8cpp_ab4c41c2a753542357d6b12fb6876db19_cgraph_map" alt=""></div>
<map name="lbann__layer_8cpp_ab4c41c2a753542357d6b12fb6876db19_cgraph_map" id="lbann__layer_8cpp_ab4c41c2a753542357d6b12fb6876db19_cgraph">
<area shape="rect" id="node3" href="lbann__layer_8cpp.html#aecb37a9bbeb1d09e7efd47d23a3a9d9a" title="create_types" alt="" coords="140,5,236,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aec1a3889694dc0ee7c604743f5e7dbf5"></a><!-- doxytag: member="lbann_layer.cpp::writeDist" ref="aec1a3889694dc0ee7c604743f5e7dbf5" args="(int fd, const char *filename, const DistMat &amp;M, uint64_t *bytes)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool writeDist </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="lbann__base_8hpp.html#a270ddda44ad6a3abd3cfe8358cf581e6">DistMat</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t *&nbsp;</td>
          <td class="paramname"> <em>bytes</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lbann__layer_8cpp_source.html#l00169">169</a> of file <a class="el" href="lbann__layer_8cpp_source.html">lbann_layer.cpp</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00170"></a>00170 {
<a name="l00171"></a>00171     <span class="keyword">struct </span><a class="code" href="structlayer__header.html">layer_header</a> header;
<a name="l00172"></a>00172     header.rank        = (uint64_t) M.Grid().Rank();
<a name="l00173"></a>00173     header.width       = (uint64_t) M.Width();
<a name="l00174"></a>00174     header.height      = (uint64_t) M.Height();
<a name="l00175"></a>00175     header.localwidth  = (uint64_t) M.LocalWidth();
<a name="l00176"></a>00176     header.localheight = (uint64_t) M.LocalHeight();
<a name="l00177"></a>00177     header.ldim        = (uint64_t) M.LDim();
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     ssize_t write_rc = write(fd, &amp;header, <span class="keyword">sizeof</span>(header));
<a name="l00180"></a>00180     <span class="keywordflow">if</span> (write_rc != <span class="keyword">sizeof</span>(header)) {
<a name="l00181"></a>00181         <span class="comment">// error!</span>
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183     *bytes += write_rc;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <span class="keyword">const</span> Int localHeight = M.LocalHeight();
<a name="l00186"></a>00186     <span class="keyword">const</span> Int localWidth = M.LocalWidth();
<a name="l00187"></a>00187     <span class="keyword">const</span> Int lDim = M.LDim();
<a name="l00188"></a>00188     <span class="keywordflow">if</span>(localHeight == lDim) {
<a name="l00189"></a>00189         <span class="keywordtype">void</span>* buf = (<span class="keywordtype">void</span>*) M.LockedBuffer();
<a name="l00190"></a>00190         <span class="keywordtype">size_t</span> bufsize = localHeight * localWidth * <span class="keyword">sizeof</span>(<a class="code" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a>);
<a name="l00191"></a>00191         write_rc = write(fd, buf, bufsize);
<a name="l00192"></a>00192         <span class="keywordflow">if</span> (write_rc != bufsize) {
<a name="l00193"></a>00193             <span class="comment">// error!</span>
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195         *bytes += write_rc;
<a name="l00196"></a>00196     } <span class="keywordflow">else</span> {
<a name="l00197"></a>00197         <span class="keywordflow">for</span>(Int j = 0; j &lt; localWidth; ++j) {
<a name="l00198"></a>00198             <span class="keywordtype">void</span>* buf = (<span class="keywordtype">void</span>*) M.LockedBuffer(0, j);
<a name="l00199"></a>00199             <span class="keywordtype">size_t</span> bufsize = localHeight * <span class="keyword">sizeof</span>(<a class="code" href="lbann__base_8hpp.html#a279b64f47fb2213ad73e59be937afcfa">DataType</a>);
<a name="l00200"></a>00200             write_rc = write(fd, buf, bufsize);
<a name="l00201"></a>00201             <span class="keywordflow">if</span> (write_rc != bufsize) {
<a name="l00202"></a>00202                 <span class="comment">// error!</span>
<a name="l00203"></a>00203             }
<a name="l00204"></a>00204             *bytes += write_rc;
<a name="l00205"></a>00205         }
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00209"></a>00209 }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="lbann__layer_8cpp_aec1a3889694dc0ee7c604743f5e7dbf5_icgraph.png" border="0" usemap="#lbann__layer_8cpp_aec1a3889694dc0ee7c604743f5e7dbf5_icgraph_map" alt=""></div>
<map name="lbann__layer_8cpp_aec1a3889694dc0ee7c604743f5e7dbf5_icgraph_map" id="lbann__layer_8cpp_aec1a3889694dc0ee7c604743f5e7dbf5_icgraph">
<area shape="rect" id="node3" href="classlbann_1_1Layer.html#abe469288e72b03dcd5da83b994148f7b" title="lbann::Layer::saveToCheckpoint" alt="" coords="128,5,339,35"/></map>
</div>
</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 21 Sep 2016 for LBANN by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
